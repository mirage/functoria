<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>DSL (functoria.Functoria_app.DSL)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">functoria</a> &#x00BB; <a href="../index.html">Functoria_app</a> &#x00BB; DSL</nav><header class="odoc-preamble"><h1>Module type <code><span>Functoria_app.DSL</span></code></h1><p>The signature of Functoria-like DSLs.</p><p>The Functoria DSL.</p><p>The Functoria DSL allows users to describe how to create portable and flexible applications. It allows to pass application parameters easily using command-line arguments either at configure-time or at runtime.</p><p>Users of the Functoria DSL composes their application by defining a list of <a href="class-foreign/index.html">module</a> implementations, specify the command-line <a href="#keys">Keys</a> that are required and <a href="#combinators">combine</a> all of them together using <a href="http://dx.doi.org/10.1017/S0956796807006326">applicative</a> operators.</p><p>The DSL expression is then compiled into an <a href="#app">application builder</a>, which will, once evaluated, produced the final portable and flexible application.</p></header><nav class="odoc-toc"><ul><li><a href="#combinators">Combinators</a></li><li><a href="#keys">Keys</a></li><li><a href="#pkg">Package dependencies</a></li><li><a href="#app">Application Builder</a></li><li><a href="#sharing">Sharing</a></li></ul></nav><div class="odoc-content"><h2 id="combinators"><a href="#combinators" class="anchor"></a>Combinators</h2><div class="odoc-spec"><div class="spec type" id="type-typ" class="anchored"><a href="#type-typ" class="anchor"></a><code><span><span class="keyword">type</span> <span>_ typ</span></span><span> = <span><span class="type-var">_</span> <a href="../../Functoria/index.html#type-typ">Functoria.typ</a></span></span><span> = </span></code><table><tr id="type-typ.Type" class="anchored"><td class="def variant constructor"><a href="#type-typ.Type" class="anchor"></a><code><span>| </span><span><span class="constructor">Type</span> : <span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="#type-typ">typ</a></span></span></code></td></tr><tr id="type-typ.Function" class="anchored"><td class="def variant constructor"><a href="#type-typ.Function" class="anchor"></a><code><span>| </span><span><span class="constructor">Function</span> : <span><span class="type-var">'b</span> <a href="#type-typ">typ</a></span> * <span><span class="type-var">'c</span> <a href="#type-typ">typ</a></span> <span class="arrow">&#45;&gt;</span> <span><span>( <span><span class="type-var">'b</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'c</span> )</span> <a href="#type-typ">typ</a></span></span></code></td></tr></table></div><div class="spec-doc"><p>The type for values representing module types.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-typ" class="anchored"><a href="#val-typ" class="anchor"></a><code><span><span class="keyword">val</span> typ : <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-typ">typ</a></span></span></code></div><div class="spec-doc"><p><code>type t</code> is a value representing the module type <code>t</code>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-(@-&gt;)" class="anchored"><a href="#val-(@-&gt;)" class="anchor"></a><code><span><span class="keyword">val</span> (@-&gt;) : <span><span><span class="type-var">'a</span> <a href="#type-typ">typ</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'b</span> <a href="#type-typ">typ</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span>( <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span> )</span> <a href="#type-typ">typ</a></span></span></code></div><div class="spec-doc"><p>Construct a functor type from a type and an existing functor type. This corresponds to prepending a parameter to the list of functor parameters. For example:</p><pre><code>kv_ro @-&gt; ip @-&gt; kv_ro </code></pre><p>This describes a functor type that accepts two arguments -- a <code>kv_ro</code> and an <code>ip</code> device -- and returns a <code>kv_ro</code>.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-job" class="anchored"><a href="#type-job" class="anchor"></a><code><span><span class="keyword">type</span> job</span><span> = <a href="../../Functoria/index.html#type-job">Functoria.job</a></span></code></div><div class="spec-doc"><p>Type for job values.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-job" class="anchored"><a href="#val-job" class="anchor"></a><code><span><span class="keyword">val</span> job : <span><a href="#type-job">job</a> <a href="#type-typ">typ</a></span></span></code></div><div class="spec-doc"><p><code>job</code> is the signature for user's application main module.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-impl" class="anchored"><a href="#type-impl" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a impl</span></span><span> = <span><span class="type-var">'a</span> <a href="../../Functoria/index.html#type-impl">Functoria.impl</a></span></span></code></div><div class="spec-doc"><p>The type for values representing module implementations.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-($)" class="anchored"><a href="#val-($)" class="anchor"></a><code><span><span class="keyword">val</span> ($) : <span><span><span>( <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span> )</span> <a href="#type-impl">impl</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-impl">impl</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <a href="#type-impl">impl</a></span></span></code></div><div class="spec-doc"><p><code>m $ a</code> applies the functor <code>m</code> to the module <code>a</code>.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-abstract_impl" class="anchored"><a href="#type-abstract_impl" class="anchor"></a><code><span><span class="keyword">type</span> abstract_impl</span><span> = <a href="../../Functoria/index.html#type-abstract_impl">Functoria.abstract_impl</a></span><span> = </span></code><table><tr id="type-abstract_impl.Abstract" class="anchored"><td class="def variant constructor"><a href="#type-abstract_impl.Abstract" class="anchor"></a><code><span>| </span><span><span class="constructor">Abstract</span> : <span><span class="type-var">_</span> <a href="#type-impl">impl</a></span> <span class="arrow">&#45;&gt;</span> <a href="#type-abstract_impl">abstract_impl</a></span></code></td></tr></table></div><div class="spec-doc"><p>The type for abstract implementations.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-abstract" class="anchored"><a href="#val-abstract" class="anchor"></a><code><span><span class="keyword">val</span> abstract : <span><span><span class="type-var">_</span> <a href="#type-impl">impl</a></span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-abstract_impl">abstract_impl</a></span></code></div><div class="spec-doc"><p><code>abstract t</code> is <code>t</code> but with its type variable abstracted. Useful for dependencies.</p></div></div><h2 id="keys"><a href="#keys" class="anchor"></a>Keys</h2><div class="odoc-spec"><div class="spec type" id="type-key" class="anchored"><a href="#type-key" class="anchor"></a><code><span><span class="keyword">type</span> key</span><span> = <a href="../../Functoria_key/index.html#type-t">Functoria_key.t</a></span></code></div><div class="spec-doc"><p>The type for command-line keys. See <a href="../../Functoria_key/index.html#type-t"><code>Functoria_key.t</code></a>.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-context" class="anchored"><a href="#type-context" class="anchor"></a><code><span><span class="keyword">type</span> context</span><span> = <a href="../../Functoria_key/index.html#type-context">Functoria_key.context</a></span></code></div><div class="spec-doc"><p>The type for keys' parsing context. See <a href="../../Functoria_key/index.html#type-context"><code>Functoria_key.context</code></a>.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-value" class="anchored"><a href="#type-value" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a value</span></span><span> = <span><span class="type-var">'a</span> <a href="../../Functoria_key/index.html#type-value">Functoria_key.value</a></span></span></code></div><div class="spec-doc"><p>The type for values parsed from the command-line. See <a href="../../Functoria_key/index.html#type-value"><code>Functoria_key.value</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-if_impl" class="anchored"><a href="#val-if_impl" class="anchor"></a><code><span><span class="keyword">val</span> if_impl : <span><span>bool <a href="#type-value">value</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-impl">impl</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-impl">impl</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-impl">impl</a></span></span></code></div><div class="spec-doc"><p><code>if_impl v impl1 impl2</code> is <code>impl1</code> if <code>v</code> is resolved to true and <code>impl2</code> otherwise.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-match_impl" class="anchored"><a href="#val-match_impl" class="anchor"></a><code><span><span class="keyword">val</span> match_impl : <span><span><span class="type-var">'b</span> <a href="#type-value">value</a></span> <span class="arrow">&#45;&gt;</span></span> <span>default:<span><span class="type-var">'a</span> <a href="#type-impl">impl</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span>(<span class="type-var">'b</span> * <span><span class="type-var">'a</span> <a href="#type-impl">impl</a></span>)</span> list</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-impl">impl</a></span></span></code></div><div class="spec-doc"><p><code>match_impl v cases ~default</code> chooses the implementation amongst <code>cases</code> by matching the <code>v</code>'s value. <code>default</code> is chosen if no value matches.</p></div></div><div class="odoc-spec"><div class="spec module-type" id="module-type-KEY" class="anchored"><a href="#module-type-KEY" class="anchor"></a><code><span><span class="keyword">module</span> <span class="keyword">type</span> KEY</span><span> = <a href="../../Functoria/module-type-KEY/index.html">Functoria.KEY</a></span></code></div><div class="spec-doc"><p>The signature for run-time and configure-time command-line keys.</p></div></div><h2 id="pkg"><a href="#pkg" class="anchor"></a>Package dependencies</h2><p>For specifying opam package dependencies, the type <a href="#val-package"><code>package</code></a> is used. It consists of the opam package name, the ocamlfind names, and optional lower and upper bounds. The version constraints are merged with other modules.</p><div class="odoc-spec"><div class="spec type" id="type-package" class="anchored"><a href="#type-package" class="anchor"></a><code><span><span class="keyword">type</span> package</span><span> = <span class="keyword">private</span> <a href="../../Functoria/index.html#type-package">Functoria.package</a></span><span> = </span><span>{</span></code><table><tr id="type-package.opam" class="anchored"><td class="def record field"><a href="#type-package.opam" class="anchor"></a><code><span>opam : string;</span></code></td></tr><tr id="type-package.pin" class="anchored"><td class="def record field"><a href="#type-package.pin" class="anchor"></a><code><span>pin : <span>string option</span>;</span></code></td></tr><tr id="type-package.build" class="anchored"><td class="def record field"><a href="#type-package.build" class="anchor"></a><code><span>build : bool;</span></code></td></tr><tr id="type-package.ocamlfind" class="anchored"><td class="def record field"><a href="#type-package.ocamlfind" class="anchor"></a><code><span>ocamlfind : <span class="xref-unresolved">Astring</span>.String.Set.t;</span></code></td></tr><tr id="type-package.min" class="anchored"><td class="def record field"><a href="#type-package.min" class="anchor"></a><code><span>min : <span class="xref-unresolved">Astring</span>.String.Set.t;</span></code></td></tr><tr id="type-package.max" class="anchored"><td class="def record field"><a href="#type-package.max" class="anchor"></a><code><span>max : <span class="xref-unresolved">Astring</span>.String.Set.t;</span></code></td></tr></table><code><span>}</span></code></div><div class="spec-doc"><p>The type of a package</p></div></div><div class="odoc-spec"><div class="spec value" id="val-package" class="anchored"><a href="#val-package" class="anchor"></a><code><span><span class="keyword">val</span> package : 
  <span>?build:bool <span class="arrow">&#45;&gt;</span></span>
  <span>?sublibs:<span>string list</span> <span class="arrow">&#45;&gt;</span></span>
  <span>?ocamlfind:<span>string list</span> <span class="arrow">&#45;&gt;</span></span>
  <span>?min:string <span class="arrow">&#45;&gt;</span></span>
  <span>?max:string <span class="arrow">&#45;&gt;</span></span>
  <span>?pin:string <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-package">package</a></span></code></div><div class="spec-doc"><p><code>package ~build ~sublibs ~ocamlfind ~min ~max ~pin opam</code> is a <code>package</code>. <code>Build</code> indicates a build-time dependency only, defaults to <code>false</code>. The ocamlfind name is by default the same as <code>opam</code>, you can specify <code>~sublibs</code> to add additional sublibraries (e.g. <code>~sublibs:[&quot;mirage&quot;] &quot;foo&quot;</code> will result in the findlib names <code> [&quot;foo&quot;; &quot;foo.mirage&quot;] </code>. In case the findlib name is disjoint (or empty), use <code>~ocamlfind</code>. Specifying both <code>~ocamlfind</code> and <code>~sublibs</code> leads to an invalid argument. Version constraints are given as <code>min</code> (inclusive) and <code>max</code> (exclusive). If <code>pin</code> is provided, a <a href="https://opam.ocaml.org/doc/Manual.html#opamfield-pin-depends">pin-depends</a> is generated.</p></div></div><h2 id="app"><a href="#app" class="anchor"></a>Application Builder</h2><p>Values of type <a href="#val-impl"><code>impl</code></a> are tied to concrete module implementation with the <a href="class-foreign/index.html"><code>foreign</code></a> construct. Module implementations of type <a href="#val-job"><code>job</code></a> can then be <a href="../Make/index.html#val-register">registered</a> into an application builder. The builder is in charge if parsing the command-line arguments and of generating code for the final application. See <a href="../index.html"><code>Functoria_app</code></a> for details.</p><div class="odoc-spec"><div class="spec value" id="val-foreign" class="anchored"><a href="#val-foreign" class="anchor"></a><code><span><span class="keyword">val</span> foreign : 
  <span>?packages:<span><a href="#type-package">package</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span>?keys:<span><a href="#type-key">key</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span>?deps:<span><a href="#type-abstract_impl">abstract_impl</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <a href="#type-typ">typ</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <a href="#type-impl">impl</a></span></span></code></div><div class="spec-doc"><p><code>foreign name typ</code> is the module <code>name</code>, having the module type <code>typ</code>.</p><ul><li>If <code>packages</code> is set, then the given packages are installed before compiling the current application.</li><li>If <code>keys</code> is set, use the given <a href="../../Functoria_key/index.html#type-key">keys</a> to parse at configure and runtime the command-line arguments before calling <code>name.connect</code>.</li><li>If <code>deps</code> is set, the given list of <a href="#type-abstract_impl">abstract</a> implementations is added as data-dependencies: they will be initialized before calling <code>name.connect</code>.</li></ul><p>For a more flexible definition of packages, or for a custom configuration step, see the <a href="class-type-configurable/index.html"><code>configurable</code></a> class type and the <a href="class-foreign/index.html"><code>foreign</code></a> class.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Info" class="anchored"><a href="#module-Info" class="anchor"></a><code><span><span class="keyword">module</span> Info</span><span> = <a href="../../Functoria/Info/index.html">Functoria.Info</a></span></code></div><div class="spec-doc"><p>Information about the final application.</p></div></div><div class="odoc-spec"><div class="spec class-type" id="class-type-configurable" class="anchored"><a href="#class-type-configurable" class="anchor"></a><code><span><span class="keyword">class</span> <span class="keyword">type</span> 'ty </span><span><a href="class-type-configurable/index.html">configurable</a></span><span> = <span class="keyword">object</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Signature for configurable module implementations. A <code>configurable</code> is a module implementation which contains a runtime state which can be set either at configuration time (by the application builder) or at runtime, using command-line arguments.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-impl" class="anchored"><a href="#val-impl" class="anchor"></a><code><span><span class="keyword">val</span> impl : <span><span><span class="type-var">'a</span> <a href="class-type-configurable/index.html">configurable</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-impl">impl</a></span></span></code></div><div class="spec-doc"><p><code>impl c</code> is the implementation of the configurable <code>c</code>.</p></div></div><div class="odoc-spec"><div class="spec class" id="class-base_configurable" class="anchored"><a href="#class-base_configurable" class="anchor"></a><code><span><span class="keyword">class</span>  </span><span><a href="class-base_configurable/index.html">base_configurable</a></span><span> : <span class="keyword">object</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p><code>base_configurable</code> pre-defining many methods from the <a href="class-type-configurable/index.html"><code>configurable</code></a> class. To be used as follow:</p></div></div><div class="odoc-spec"><div class="spec class" id="class-foreign" class="anchored"><a href="#class-foreign" class="anchor"></a><code><span><span class="keyword">class</span> 'a </span><span><a href="class-foreign/index.html">foreign</a></span><span> : <span>?packages:<span><a href="#type-package">package</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span>?keys:<span><a href="#type-key">key</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span>?deps:<span><a href="#type-abstract_impl">abstract_impl</a> list</span> <span class="arrow">&#45;&gt;</span></span> <span>
  string <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-typ">typ</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="class-type-configurable/index.html">configurable</a></span></span></code></div><div class="spec-doc"><p>This class can be inherited to define a <a href="class-type-configurable/index.html"><code>configurable</code></a> with an API similar to <a href="class-foreign/index.html"><code>foreign</code></a>.</p></div></div><h2 id="sharing"><a href="#sharing" class="anchor"></a>Sharing</h2><div class="odoc-spec"><div class="spec value" id="val-hash" class="anchored"><a href="#val-hash" class="anchor"></a><code><span><span class="keyword">val</span> hash : <span><span><span class="type-var">'a</span> <a href="#type-impl">impl</a></span> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>hash</code> is the hash function on implementations. FIXME(samoht) expand on how it works.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-equal" class="anchored"><a href="#val-equal" class="anchor"></a><code><span><span class="keyword">val</span> equal : <span><span><span class="type-var">'a</span> <a href="#type-impl">impl</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-impl">impl</a></span> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p><code>equal</code> is the equality over implementations.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-ImplTbl" class="anchored"><a href="#module-ImplTbl" class="anchor"></a><code><span><span class="keyword">module</span> ImplTbl</span><span> = <a href="../../Functoria/ImplTbl/index.html">Functoria.ImplTbl</a></span></code></div><div class="spec-doc"><p>Hashtbl of implementations.</p></div></div></div></body></html>